> ### å†™åœ¨å‰é¢ï¼š
> 
> æˆ‘çš„Linuxçš„å­¦ä¹ ä¹‹è·¯éå¸¸åå·ã€‚ç¬¬ä¸€æ¬¡å­¦ä¹ Linuxæ˜¯åœ¨å¤§ä¸€ä¸‹çš„å¼€å­¦æ²¡å¤šä¹…ï¼Œç»“æœå› ä¸ºä¸ä¼šå®‰è£…VMwareå°±æ— ç–¾è€Œç»ˆäº†ï¼Œå¯ä»¥è¯´æ˜¯æ²¡å¼€å§‹å°±å¤±è´¥äº†ã€‚ç¬¬äºŒæ¬¡å­¦ä¹ Linuxæ˜¯åœ¨å¤§ä¸€ä¸‹å¿«æ”¾æš‘å‡ï¼ˆé‚£ä¸ªæ—¶å€™åˆšåˆšè¿‡å®Œè€ƒè¯•å‘¨ï¼‰ï¼Œæˆ‘æ²¡ä»€ä¹ˆäº‹åšå°±åˆé‡æ‹¾Linuxï¼Œä¸æœè¾“çš„æˆ‘é€‰æ‹©å†æˆ˜Linuxï¼Œè¿™ä¸€æ¬¡å­¦ä¹ è¿˜ç®—é¡ºåˆ©ï¼Œè™½ç„¶ä¸­é—´æœ‰äº›å°æ’æ›²ä½†æ˜¯ä¸å½±å“æ•´ä½“å­¦ä¹ è¿›åº¦ï¼Œ æˆ‘çœ‹ç€Bç«™ä¸Šçš„è§†é¢‘ä¸€ç‚¹ç‚¹å­¦ä¹ Linuxï¼ŒåŸºæœ¬ä¸ŠæŠŠLinuxçš„åŸºç¡€æŒ‡ä»¤å­¦å®Œäº†ã€‚å­¦å®Œä¹‹åæˆ‘åˆé‡åˆ°é—®é¢˜äº†ï¼Œè§†é¢‘åŸºæœ¬ä¸Šåˆ°è¿™å°±ç»“æŸäº†ï¼Œè€Œæˆ‘å´ä¸çŸ¥é“ä¸‹ä¸€æ­¥è¯¥å­¦ä»€ä¹ˆï¼Œäºæ˜¯å°±æ²¡æ€ä¹ˆç¢°Linuxï¼Œç»“æœæ²¡è¿‡å¤šé•¿æ—¶é—´æˆ‘å°±æŠŠå­¦çš„LinuxæŒ‡ä»¤å¿˜çš„ä¸€å¹²äºŒå‡€ã€‚ç°åœ¨æ˜¯æˆ‘ç¬¬ä¸‰æ¬¡å­¦ä¹ Linuxï¼Œæˆ‘å†³å®šé‡æ–°å¼€å§‹å­¦Linuxï¼ŒåŒæ—¶ä¸ºäº†è®©è‡ªå·±å­¦ä¹ çš„æ•ˆæœæ›´å¥½ï¼Œæˆ‘é€‰æ‹©ä»¥å†™blogçš„å½¢å¼é€¼è¿«è‡ªå·±æ¯å¤©æŠŠå­¦ä¹ åˆ°çš„LinuxçŸ¥è¯†æ•´ç†ä¸‹æ¥ã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘å†™è¿™ä¸ªç³»åˆ—blogçš„åŸå› ã€‚

---

## è¿›ç¨‹ç»„å’Œä¼šè¯

### è¿›ç¨‹ç»„ï¼ˆåˆ«åï¼šä½œä¸šï¼‰

- å¤šä¸ªè¿›ç¨‹çš„é›†åˆï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½å±äºä¸€ä¸ªè¿›ç¨‹ç»„ï¼Œç®€åŒ–å¯¹å¤šä¸ªè¿›ç¨‹çš„ç®¡ç†ï¼Œ`waitpid`å’Œ`kill`å‡½æ•°çš„å‚æ•°ä¸­ç”¨åˆ°ã€‚
- çˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™é»˜è®¤çˆ¶å­è¿›ç¨‹å±äºåŒä¸€è¿›ç¨‹ç»„ã€‚è¿›ç¨‹ç»„çš„ID==ç¬¬ä¸€ä¸ªè¿›ç¨‹IDï¼ˆç»„é•¿è¿›ç¨‹ï¼‰ï¼Œç»„é•¿è¿›ç¨‹id==è¿›ç¨‹ç»„idï¼Œç»„é•¿è¿›ç¨‹å¯ä»¥åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ç»„ï¼Œåˆ›å»ºè¯¥è¿›ç¨‹ç»„ä¸­çš„è¿›ç¨‹ï¼Œç„¶åç»ˆæ­¢ã€‚
- åªè¦æœ‰ä¸€ä¸ªè¿›ç¨‹å­˜åœ¨ï¼Œè¿›ç¨‹ç»„å°±å­˜åœ¨ï¼Œç”Ÿå­˜æœŸä¸ç»„é•¿è¿›ç¨‹æ˜¯å¦ç»ˆæ­¢æ— å…³
- `kill -SIGKILL -è¿›ç¨‹ç»„id` æ€æ‰æ•´ä¸ªè¿›ç¨‹ç»„
- ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ä¸ºè‡ªå·±æˆ–å­è¿›ç¨‹è®¾ç½®è¿›ç¨‹ç»„id

### ä¼šè¯

å¤šä¸ªè¿›ç¨‹ç»„çš„é›†åˆ
![1](https://img-blog.csdnimg.cn/direct/861b947df5234baaa95b27202e962841.png#pic_center)
åˆ›å»ºä¼šè¯çš„æ³¨æ„äº‹é¡¹

- è°ƒç”¨è¿›ç¨‹ä¸èƒ½æ˜¯è¿›ç¨‹ç»„ç»„é•¿ï¼Œè¯¥è¿›ç¨‹å˜æˆæ–°ä¼šè¯é¦–è¿›ç¨‹ï¼ˆå¹³æ°‘ï¼‰
- è¯¥è¿›ç¨‹æˆä¸ºä¸€ä¸ªæ–°è¿›ç¨‹ç»„çš„ç»„é•¿è¿›ç¨‹
- éœ€è¦rootæƒé™ï¼ˆubuntuä¸éœ€è¦ï¼‰
- æ–°ä¼šè¯ä¸¢å¼ƒåŸæœ‰çš„æ§åˆ¶ç»ˆç«¯ï¼Œè¯¥ä¼šè¯æ²¡æœ‰æ§åˆ¶ç»ˆç«¯
- è¯¥è°ƒç”¨è¿›ç¨‹æ˜¯ç»„é•¿è¿›ç¨‹ï¼Œåˆ™å‡ºé”™è¿”å›
- å»ºç«‹æ–°ä¼šè¯æ—¶ï¼Œå…ˆè°ƒç”¨forkï¼Œçˆ¶è¿›ç¨‹ç»ˆæ­¢ï¼Œå­è¿›ç¨‹è°ƒç”¨setsid

### getpidå‡½æ•°

`pid_t getpid(pid_t pid)`

- åŠŸèƒ½ï¼šè·å–å½“å‰è¿›ç¨‹çš„ä¼šè¯id
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼Œè¿”å›è°ƒç”¨è¿›ç¨‹çš„ä¼šè¯id
  - å¤±è´¥ï¼Œ-1ï¼Œè®¾ç½®`errno`

### setsidå‡½æ•°

`pid_t setsid()`

- åŠŸèƒ½ï¼šåˆ›å»ºä¸€ä¸ªä¼šè¯ï¼Œå¹¶ä»¥è‡ªå·±çš„idè®¾ç½®è¿›ç¨‹idï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ–°ä¼šè¯id
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼Œè¿”å›è°ƒç”¨è¿›ç¨‹çš„ä¼šè¯id
  - å¤±è´¥ï¼Œ-1ï¼Œè®¾ç½®`errno`

---

## å®ˆæŠ¤è¿›ç¨‹

### æ¦‚å¿µå’Œç‰¹ç‚¹

- `daemon`è¿›ç¨‹ã€‚é€šå¸¸è¿è¡Œä¸æ“ä½œç³»ç»Ÿåå°ï¼Œè„±ç¦»æ§åˆ¶ç»ˆç«¯ã€‚ä¸€èˆ¬ä¸ä¸ç”¨æˆ·ç›´æ¥äº¤äº’ã€‚å‘¨æœŸæ€§çš„ç­‰å¾…æŸä¸ªäº‹ä»¶å‘ç”Ÿæˆ–è€…å‘¨æœŸæ€§æ‰§è¡ŒæŸä¸€åŠ¨ä½œã€‚
- ä¸å—ç”¨æˆ·ç™»å½•æ³¨é”€å½±å“ï¼Œé€šå¸¸é‡‡ç”¨ä»¥dç»“å°¾çš„å‘½åæ–¹å¼ã€‚
- åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„å…³é”®æ˜¯è°ƒç”¨`setsid()`å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ `session`,å¹¶æˆä¸º`session leader`.

### æ­¥éª¤

1. `fork`å­è¿›ç¨‹ï¼Œè®©çˆ¶è¿›ç¨‹ç»ˆæ­¢ã€‚
2. å­è¿›ç¨‹è°ƒç”¨ `setsid()` åˆ›å»ºæ–°ä¼šè¯
3. é€šå¸¸æ ¹æ®éœ€è¦ï¼Œæ”¹å˜å·¥ä½œç›®å½•ä½ç½®` chdir()`ï¼Œ é˜²æ­¢ç›®å½•è¢«å¸è½½ã€‚
4. é€šå¸¸æ ¹æ®éœ€è¦ï¼Œé‡è®¾umaskæ–‡ä»¶æƒé™æ©ç ï¼Œå½±å“æ–°æ–‡ä»¶çš„åˆ›å»ºæƒé™ã€‚ï¼ˆä¸€èˆ¬è®¾ç½®ä¸º`022`)
5. é€šå¸¸æ ¹æ®éœ€è¦ï¼Œå…³é—­/é‡å®šå‘ æ–‡ä»¶æè¿°ç¬¦.
6. å®ˆæŠ¤è¿›ç¨‹ ä¸šåŠ¡é€»è¾‘ã€‚

### ä¸¾ä¸ªæ —å­

æºä»£ç ï¼š

```c
#include<stdio.h>
#include<unistd.h>
#include<stdlib.h>
#include<fcntl.h>
#include<sys/stat.h>

int main()
{
    pid_t pid;
    pid=fork();
    if(pid>0)
    {
        printf("i am parent,my session id is %d\n",getsid(getpid()));
        exit(1);
    }
    printf("i am child,my session id is %d\n",getsid(getpid()));
    int res=setsid();
    if(res<0)
    {
        perror("getsid error");
        exit(1);
    }    
    printf("i am child, my session id has changed to %d\n",res);
    umask(0002);
    close(STDIN_FILENO);
    int fd=open("/dev/null",O_RDWR);
    dup2(fd,STDOUT_FILENO);
    dup2(fd,STDERR_FILENO);
    while(1);
}
```

æ•ˆæœï¼š
![2](https://img-blog.csdnimg.cn/direct/f6ea0a987f2e47f38102b75452188585.png#pic_center)
![3](https://img-blog.csdnimg.cn/direct/9f094abf71f24144bc3112a1e94b3342.png#pic_center)

> **è¿™ä¸ªdaemonä¸ä¼šå—ç”¨æˆ·ç™»å½•æ³¨é”€å½±å“ï¼Œæƒ³è¦ç»ˆæ­¢å¿…é¡»ä½¿ç”¨`kill`å‘½ä»¤**

---

## çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ

è¿›ç¨‹ï¼šæœ‰ç‹¬ç«‹çš„ è¿›ç¨‹åœ°å€ç©ºé—´ã€‚æœ‰ç‹¬ç«‹çš„pcbã€‚    åˆ†é…èµ„æºçš„æœ€å°å•ä½ã€‚
çº¿ç¨‹ï¼šæœ‰ç‹¬ç«‹çš„pcbã€‚æ²¡æœ‰ç‹¬ç«‹çš„è¿›ç¨‹åœ°å€ç©ºé—´ã€‚    æœ€å°å•ä½çš„æ‰§è¡Œã€‚
![1](https://img-blog.csdnimg.cn/direct/2401a627c50f428fbaf592456dfe3696.png#pic_center)
`ps -Lf çº¿ç¨‹id`â€”â€”> çº¿ç¨‹å·LWPï¼ŒCPUæ‰§è¡Œçš„æœ€å°å•ä½
`ps -Lf è¿›ç¨‹å·`â€”â€”> æŸ¥çœ‹è¿›ç¨‹çš„çº¿ç¨‹

çº¿ç¨‹å…±äº«ï¼š `./text./data ./rodataa ./bsss heap`  ---> å…±äº«ã€å…¨å±€å˜é‡ã€‘ï¼ˆ`errno`ï¼‰
çº¿ç¨‹éå…±äº«ï¼šæ ˆç©ºé—´ï¼ˆå†…æ ¸æ ˆã€ç”¨æˆ·æ ˆï¼‰

> **ä¸‰çº§æ˜ å°„**
> 
> 1. è½»é‡çº§çº¿ç¨‹ï¼Œå­˜åœ¨pcbï¼Œåˆ›å»ºçº¿ç¨‹ä½¿ç”¨çš„åº•å±‚å‡½æ•°å’Œè¿›ç¨‹ä¸€æ ·ï¼Œéƒ½æ˜¯clone
> 2. ä»å†…æ ¸çœ‹è¿›ç¨‹å’Œçº¿ç¨‹ä¸€æ ·ï¼Œéƒ½æœ‰å„è‡ªä¸åŒçš„pcbï¼Œä½†æ˜¯pcbä¸­æŒ‡å‘å†…å­˜èµ„æºçš„ä¸‰çº§é¡µè¡¨æ˜¯ç›¸åŒçš„
> 3. è¿›ç¨‹å¯ä»¥å˜æˆçº¿ç¨‹
> 4. çº¿ç¨‹å¯ä»¥çœ‹æˆå¯„å­˜å™¨å’Œæ ˆçš„é›†åˆ
> 5. çº¿ç¨‹æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œè¿›ç¨‹æ˜¯æœ€å°çš„èµ„æºåˆ†é…çš„å•ä½
>    ![2](https://img-blog.csdnimg.cn/direct/0185caca28ae4a859d7a072e6d6dca43.png#pic_center)

---

## åˆ›å»ºçº¿ç¨‹

### `pthread_self()`å‡½æ•°

`pthread_t pthread_self();`

- åŠŸèƒ½ï¼šè·å–çº¿ç¨‹idã€‚çº¿ç¨‹idæ˜¯åœ¨ã€è¿›ç¨‹ã€‘åœ°å€ç©ºé—´å†…éƒ¨ï¼Œç”¨æ¥æ ‡è¯†çº¿ç¨‹èº«ä»½çš„idå·ã€‚
- è¿”å›å€¼ï¼šæœ¬çº¿ç¨‹çš„idå·ã€‚

### `pthread_create()`å‡½æ•°

`int pthread_create(pthread_t* tid,const pthread_attr_t* attr,void* (*start_rountn)(void*),void* arg);`

- åŠŸèƒ½ï¼šåˆ›å»ºå­çº¿ç¨‹
- å‚æ•°
  - `tid`:ä¼ å‡ºå‚æ•°ï¼Œè¡¨ç¤ºæ–°åˆ›å»ºçš„å­çº¿ç¨‹id
  - `attr`:çº¿ç¨‹å±æ€§ï¼Œä¸€èˆ¬ä¼ `NULL`è¡¨ç¤ºé»˜è®¤å±æ€§ã€‚
  - `start_rountn`:å­çº¿ç¨‹å›è°ƒå‡½æ•°ã€‚åˆ›å»ºæˆåŠŸï¼Œ`pthread`è¿”å›æ—¶ï¼Œè¯¥å‡½æ•°è‡ªåŠ¨è¢«è°ƒç”¨ã€‚
  - `arg`:å›è°ƒå‡½æ•°çš„å‚æ•°ï¼Œæ²¡æœ‰çš„è¯ï¼Œä¼ `NULL`.
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼Œ0
  - å¤±è´¥ï¼Œè¿”å›é”™è¯¯å·`ret`
    
    > è¿™é‡Œè¦æ³¨æ„ï¼Œçº¿ç¨‹é‡Œé”™è¯¯æ£€æŸ¥å’Œå…¶ä»–åœ°æ–¹æœ‰äº›ä¸ä¸€æ ·ã€‚çº¿ç¨‹å‡ºé”™æ˜¯åªæœ‰`errno`ã€‚
    > æ‰€ä»¥ï¼š`fprintf(stderr,"XXXX error:%s\n",strerror(ret)`

### ä¸¾ä¸ªæ —å­

æºä»£ç ï¼š

```c
#include<stdio.h>
#include<unistd.h>
#include<pthread.h>
#include<string.h>
#include<stdlib.h>

void fun(void * arg)
{
    int i=(int) arg;
    sleep(i);
    printf("i am %dth pthread,my pid is %d,my tid is %lu\n",i+1,getpid(),pthread_self());
    return NULL;
}


int main()
{
    pthread_t tid;
    for(int i=0;i<5;i++)
    {
        int res=pthread_create(&tid,NULL,fun,(void*)i);
        if(res!=0)
        {
            fprintf(stderr,"pthread create error:%s\n",strerror(res));
            exit(1);
        }
    }
    sleep(5);
    printf("i am main,pid=%d,tid=%lu\n",getpid(),pthread_self());
    return 0;
}
```

æ•ˆæœï¼š
![1](https://img-blog.csdnimg.cn/direct/ea4dbad0620343108a8fabdad5b7fc7c.png#pic_center)

> **ç¼–è¯‘æ—¶ä¼šå‡ºç°ç±»å‹å¼ºè½¬çš„è­¦å‘Šï¼ŒæŒ‡é’ˆ4å­—èŠ‚è½¬intçš„8å­—èŠ‚ï¼Œä¸è¿‡ä¸å­˜åœ¨ç²¾åº¦æŸå¤±ï¼Œå¿½ç•¥å°±è¡Œã€‚**

---

## é€€å‡ºçº¿ç¨‹

### `pthread_exit()`

- åŠŸèƒ½ï¼šé€€å‡ºå½“å‰çº¿ç¨‹
- å‚æ•°ï¼šé€€å‡ºå€¼ï¼Œæ— é€€å‡ºå€¼æ—¶ä¼ `NULL`
  
  ### åŒºåˆ†
- `exit();`:é€€å‡ºå½“å‰è¿›ç¨‹
- `return `:è¿”å›åˆ°å‡½æ•°è°ƒç”¨è€…é‚£é‡Œ
- `pthread_exit()`:é€€å‡ºå½“å‰çº¿ç¨‹

### ä¸¾ä¸ªæ —å­

ä¸ºäº†æ›´å¥½çš„è¯´æ˜ä¸‰ç§æ–¹å¼çš„åŒºåˆ«ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç”¨ä¸Šé¢åˆ›å»ºäº”ä¸ªå­çº¿ç¨‹çš„ä¾‹å­ï¼Œåªä¸è¿‡æˆ‘ä»¬è¦é€€å‡ºç¬¬ä¸‰ä¸ªå­çº¿ç¨‹ã€‚æˆ‘ä»¬åˆ†åˆ«ç”¨è¿™ä¸‰ç§æ–¹å¼æ¥è¯•è¯•ã€‚

#### exit

æºä»£ç ï¼š

```c
#include<stdio.h>
#include<unistd.h>
#include<stdlib.h>
#include<pthread.h>
#include<errno.h>

            //the first way,use exit.
void fun(void* arg)
{
    int i=(int) arg;
    sleep(i);
    if(i==2)
        exit(1);
    printf("i am %dth pthread,my pid=%d,tid=%lu\n",i+1,getpid(),pthread_self());
    return NULL;
}


/*             the second way,use pthread_exit().
void fun(void* arg)
{
    int i=(int) arg;
    sleep(i);
    if(2==i)
        pthread_exit(1);
    printf("i am %dth pthread,my pid=%d,tid=%lu\n",i+1,getpid(),pthread_self());
    return NULL;
}
*/

/*            the third way,use return.
void fun(void* arg)
{
    int i=(int) arg;
    sleep(i);
    if(2==i)
        return NULL;
    printf("i am %dth pthread,my pid=%d,tid=%lu\n",i+1,getpid(),pthread_self());
    return NULL;
}
*/

int main()
{
    pthread_t tid;
    for(int i=0;i<5;i++)
    {
        int res=pthread_create(&tid,NULL,fun,(void*)i);
        if(res!=0)
        {
            fprintf(stderr,"pthread_create error %s\n",strerror(errno));
            exit(1);
        }
    }
    sleep(5);
    printf("i am main,my pid is %d,tid=%lu\n",getpid(),pthread_self());
    return 0;
}
```

æ•ˆæœï¼š
![1](https://img-blog.csdnimg.cn/direct/52a745d8afb94bb5817a8967e57166a8.png#pic_center)

#### pthread_exit()

æºä»£ç ï¼š

```c
#include<stdio.h>
#include<unistd.h>
#include<stdlib.h>
#include<pthread.h>
#include<errno.h>

/*            //the first way,use exit.
void fun(void* arg)
{
    int i=(int) arg;
    sleep(i);
    if(i==2)
        exit(1);
    printf("i am %dth pthread,my pid=%d,tid=%lu\n",i+1,getpid(),pthread_self());
    return NULL;
}
*/

             //the second way,use pthread_exit().
void fun(void* arg)
{
    int i=(int) arg;
    sleep(i);
    if(2==i)
        pthread_exit(1);
    printf("i am %dth pthread,my pid=%d,tid=%lu\n",i+1,getpid(),pthread_self());
    return NULL;
}


/*            the third way,use return.
void fun(void* arg)
{
    int i=(int) arg;
    sleep(i);
    if(2==i)
        return NULL;
    printf("i am %dth pthread,my pid=%d,tid=%lu\n",i+1,getpid(),pthread_self());
    return NULL;
}
*/

int main()
{
    pthread_t tid;
    for(int i=0;i<5;i++)
    {
        int res=pthread_create(&tid,NULL,fun,(void*)i);
        if(res!=0)
        {
            fprintf(stderr,"pthread_create error %s\n",strerror(errno));
            exit(1);
        }
    }
    sleep(5);
    printf("i am main,my pid is %d,tid=%lu\n",getpid(),pthread_self());
    return 0;
}
```

æ•ˆæœï¼š
![2](https://img-blog.csdnimg.cn/direct/d23b03f3ebf84db4af061fa1d861b0ea.png#pic_center)

#### return

æºä»£ç ï¼š

```c
#include<stdio.h>
#include<unistd.h>
#include<stdlib.h>
#include<pthread.h>
#include<errno.h>

/*            //the first way,use exit.
void fun(void* arg)
{
    int i=(int) arg;
    sleep(i);
    if(i==2)
        exit(1);
    printf("i am %dth pthread,my pid=%d,tid=%lu\n",i+1,getpid(),pthread_self());
    return NULL;
}
*/

/*             //the second way,use pthread_exit().
void fun(void* arg)
{
    int i=(int) arg;
    sleep(i);
    if(2==i)
        pthread_exit(1);
    printf("i am %dth pthread,my pid=%d,tid=%lu\n",i+1,getpid(),pthread_self());
    return NULL;
}
*/

            //the third way,use return.
void fun(void* arg)
{
    int i=(int) arg;
    sleep(i);
    if(2==i)
        return NULL;
    printf("i am %dth pthread,my pid=%d,tid=%lu\n",i+1,getpid(),pthread_self());
    return NULL;
}


int main()
{
    pthread_t tid;
    for(int i=0;i<5;i++)
    {
        int res=pthread_create(&tid,NULL,fun,(void*)i);
        if(res!=0)
        {
            fprintf(stderr,"pthread_create error %s\n",strerror(errno));
            exit(1);
        }
    }
    sleep(5);
    printf("i am main,my pid is %d,tid=%lu\n",getpid(),pthread_self());
    return 0;
}
```

æ•ˆæœï¼š
![2](https://img-blog.csdnimg.cn/direct/36111a97d64645f2992cf2118a85f31f.png#pic_center)

---

## å›æ”¶å­çº¿ç¨‹

`int pthread_join(pthread_t tid,void** retval);`

- åŠŸèƒ½ï¼šé˜»å¡ï¼Œå›æ”¶å­çº¿ç¨‹
- å‚æ•°ï¼š
  - `tid`:å¾…å›æ”¶çš„å­çº¿ç¨‹id
  - `retval`:ä¼ å‡ºå‚æ•°ï¼Œå›æ”¶çº¿ç¨‹çš„é€€å‡ºå€¼ã€‚
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼Œ0
  - å¤±è´¥ï¼Œè¿”å›é”™è¯¯å·

### ä¸¾ä¸ªæ —å­

æºä»£ç ï¼š

```c
#include<stdio.h>
#include<unistd.h>
#include<pthread.h>
#include<string.h>
#include<stdlib.h>
struct stu
{
    int age;
    char mesg[100];
};

void* fun(void* arg)
{
    struct stu* t;
    t=malloc(sizeof t);
    t->age=19;
    strcpy(t->mesg,"hellow linux\n");
    return (void*)t;
}

int main()
{
    pthread_t tid;
    pthread_create(&tid,NULL,fun,NULL);
    struct stu *temp;
    pthread_join(tid,(void**)&temp);
    printf("child pthread exit with age=%d,mesg=%s\n",temp->age,temp->mesg);
    return 0;
}
```

æ•ˆæœï¼š
![1](https://img-blog.csdnimg.cn/direct/2c85037947cd4e9e99773e05a9ae7cf4.png#pic_center)

### ç»¼åˆç»ƒä¹ 

æˆ‘ä»¬åˆ©ç”¨`pthread_join`å¾ªç¯å›æ”¶åˆ›å»ºçš„5å­çº¿ç¨‹
æºä»£ç ï¼š

```c
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<unistd.h>
#include<pthread.h>
#include<errno.h>

void* fun(void* arg)
{
    int i=(int) arg;
    sleep(i);
    printf("i am %dth pthread\n",i+1);
    return NULL;
}

int main()
{
    pthread_t tid[5];
    for(int i=0;i<5;i++)
    {
        int ret=pthread_create(&tid[i],NULL,fun,(void*) i);
        if(0!=ret)
        {
            fprintf(stderr,"pthread_create error:%s\n",strerror(ret));
            exit(0);
        }
    }
    for(int i=0;i<5;i++)
    {
        pthread_join(tid[i],NULL);
        printf("i am main pthread,i join %dth pthread\n",i+1);
    }
    return 0;
}
```

æ•ˆæœï¼š
![1](https://img-blog.csdnimg.cn/direct/1774f850227743dab03ea050b0a05982.png#pic_center)

---

## æ€æ­»çº¿ç¨‹

### å‡½æ•°

`int pthread_cancel(pthread_t tid);`

- åŠŸèƒ½ï¼š æ€æ­»ä¸€ä¸ªçº¿ç¨‹ã€‚ï¼ˆéœ€è¦è¾¾åˆ°å–æ¶ˆç‚¹ï¼‰
- å‚æ•°ï¼š`tid`å¾…æ€æ­»çš„çº¿ç¨‹
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼Œ0
  - å¤±è´¥ï¼Œè¿”å›é”™è¯¯å·

### ä¸¾ä¸ªæ —å­

æºä»£ç ï¼š

```c
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<unistd.h>
#include<pthread.h>


void* fun(void* arg)
{
    while(1)
    {
        printf("i am child pthread\n");        //this is a normal case
        sleep(1);

        //pthread_testcancel();            //this is to set cancel point
    }
    return (void*) 666;
}


int main()
{
    pthread_t tid;
    void* res=NULL;

    pthread_create(&tid,NULL,fun,NULL);
    sleep(3);
    pthread_cancel(tid);
    pthread_join(tid,&res);
    printf("child pthread has been killed me,and it exit with %d\n",(int) res);
    return 0;
}
```

æ•ˆæœï¼š
![1](https://img-blog.csdnimg.cn/direct/da7265debaf94e63942cbe0bd5d97cab.png#pic_center)

> è¿™é‡Œè¦æ³¨æ„ä¸€ç‚¹ï¼Œ`pthread_cancel`å·¥ä½œçš„**å¿…è¦æ¡ä»¶æ˜¯è¿›å…¥å†…æ ¸**ï¼Œå¦‚æœ`fun`çœŸçš„ç¦»è°±åˆ°æ²¡æœ‰è¿›å…¥å†…æ ¸`pthread_cancel`ä¸èƒ½æ€æ­»çº¿ç¨‹ï¼Œæ­¤æ—¶**éœ€è¦æ‰‹åŠ¨è®¾ç½®å–æ¶ˆç‚¹**ï¼Œå°±æ˜¯`pthread_testcancel()`
> è¿˜æœ‰ä¸€ç‚¹ï¼Œå¦‚æœå­çº¿ç¨‹è¢«`pthread_cancel()`æ€æ­»ï¼Œæ— è®ºå‡½æ•°é‡Œå†™çš„æ˜¯è¿”å›æ˜¯ä»€ä¹ˆï¼Œ**æœ€åéƒ½æ˜¯è¿”å›`-1`.**

---

## çº¿ç¨‹åˆ†ç¦»

### å‡½æ•°

`int pthread_detach(pthread_t tid);`

- åŠŸèƒ½ï¼šè®¾ç½®çº¿ç¨‹åˆ†ç¦»
- å‚æ•°ï¼š`tid`,å¾…åˆ†ç¦»çš„çº¿ç¨‹id
- è¿”å›å€¼ï¼š
  - æˆåŠŸï¼Œ0
  - å¤±è´¥ï¼Œè¿”å›é”™è¯¯å·

### ä¸¾ä¸ªæ —å­

æºä»£ç ï¼š

```c
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<unistd.h>
#include<pthread.h>

void* fun(void* arg)
{
     printf("i am child pthread\n");
     return NULL;
}

int main()
{
    pthread_t tid;

    pthread_create(&tid,NULL,fun,NULL);
    pthread_detach(tid);
    sleep(1);
    int res=pthread_join(tid,NULL);
    if(res!=0)
        fprintf(stderr,"pthread join error:%s\n",strerror(res));
    return 0;
}
```

æ•ˆæœï¼š
![1](https://img-blog.csdnimg.cn/direct/a65168cf9d0e4ae581ece910985a20f0.png#pic_center)

---

## çº¿ç¨‹å±æ€§è®¾ç½®åˆ†ç¦»çº¿ç¨‹

1. åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å±æ€§ç»“æ„å˜é‡:`pthread_attr_t attr;`
2. åˆå§‹åŒ–çº¿ç¨‹å±æ€§:`pthread_attr_init(&attr)`
3. è®¾ç½®çº¿ç¨‹å±æ€§ä¸ºåˆ†ç¦»æ€:`pthread_attr_setdetachstate(&attr,PTHREAD_CREATE_DETACHED);`
4. å€ŸåŠ©ä¿®æ”¹åçš„ è®¾ç½®çº¿ç¨‹å±æ€§ åˆ›å»ºä¸ºåˆ†ç¦»æ€çš„æ–°çº¿ç¨‹:`pthread_create(&tid,&attr,fun,NULL)`

---

## çº¿ç¨‹å’Œè¿›ç¨‹çš„æ¯”è¾ƒ

| **è¿›ç¨‹**             | **çº¿ç¨‹**                  |
|:------------------:|:-----------------------:|
| `fork()`           | `pthread_create()`      |
| `wait()/waitpid()` | `pthread_join()`        |
| `kill`             | `pthread_cancel()`      |
| `getpid`           | `pthread_self()`        |
| `exit`             | `pthread_exit()/return` |
|                    | `pthread_detach()`      |

---

## çº¿ç¨‹ä½¿ç”¨æ³¨æ„äº‹é¡¹

1. ä¸»çº¿ç¨‹é€€å‡ºå…¶ä»–çº¿ç¨‹ä¸é€€å‡ºï¼Œä¸»çº¿ç¨‹åº”è¯¥è°ƒç”¨`pthread_exit`
2. é¿å…åƒµå°¸çº¿ç¨‹
   - `pthread_join`
   - `thread_detach`
   - `pthread_create`æŒ‡å®šåˆ†ç¦»å±æ€§
   - è¢«`join`çº¿ç¨‹å¯èƒ½åœ¨`join`å‡½æ•°è¿”å›å‰å°±é‡Šæ”¾è‡ªå·±çš„æ‰€æœ‰å†…å­˜èµ„æºï¼Œæ‰€ä»¥ä¸åº”å½“è¿”å›è¢«å›æ”¶çº¿ç¨‹æ ˆä¸­çš„å€¼
3. `malloc`å’Œ`mmap`ç”³è¯·çš„å†…å­˜å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é‡Šæ”¾
4. åº”é¿å…åœ¨å¤šçº¿ç¨‹ä¸­è°ƒç”¨`fork`ï¼Œé™¤éé©¬`exec`ï¼Œå­çº¿ç¨‹ä¸­åªæœ‰è°ƒç”¨`fork`çš„çº¿ç¨‹å­˜åœ¨ï¼Œå…¶ä»–çº¿ç¨‹åœ¨å­è¿›ç¨‹ä¸­å‡`pthread_exit`
5. ä¿¡å·çš„å¤æ‚è¯­ä¹‰å¾ˆéš¾å’Œå¤šçº¿ç¨‹å…±å­˜ï¼Œåœ¨å¤šçº¿ç¨‹ä¸­é¿å…ä½¿ç”¨ä¿¡å·æœºåˆ¶

---

## å†™åœ¨æœ€å

ä¸ªäººäº²èº«ç»éªŒï¼šæˆ‘ä»¬å­¦ä¹ çš„ä¸€ç³»åˆ—Linuxå‘½ä»¤ï¼Œä¸€å®šè¦è‡ªå·±**äº²æ‰‹å»æ•²**ã€‚ä¸è¦åªæ˜¯çœ‹åˆ«äººæ•²ä»£ç ï¼Œä¸è¦åªæ˜¯åœç•™åœ¨çœ¼ç›çœ‹ï¼Œè„‘è¢‹ä»¥ä¸ºè‡ªå·±æ‡‚äº†ï¼Œç­‰ä½ å®é™…ä¸Šæ‰‹å»æ•²ä¼šå‘ç°è®¸è®¸å¤šå¤šçš„è¿™æ ·é‚£æ ·çš„é—®é¢˜ã€‚æ¯•ç«Ÿâ€œ**å®è·µå‡ºçœŸçŸ¥**â€ã€‚

---

> å¦‚æœä½ è§‰å¾—æˆ‘å†™çš„é¢˜è§£è¿˜ä¸é”™çš„ï¼Œè¯·å„ä½**ç‹å­å…¬ä¸»**ç§»æ­¥åˆ°æˆ‘çš„å…¶ä»–é¢˜è§£çœ‹çœ‹
> 
> 1. **æ•°æ®ç»“æ„ä¸ç®—æ³•éƒ¨åˆ†ï¼ˆè¿˜åœ¨æ›´æ–°ä¸­ï¼‰ï¼š**
>    - [***C++ STLæ€»ç»“ - åŸºäºç®—æ³•ç«èµ›ï¼ˆå¼ºåŠ›æ¨è***ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135051716?spm=1001.2014.3001.5501)
>    - [åŠ¨æ€è§„åˆ’â€”â€”å®Œå…¨èƒŒåŒ…é—®é¢˜](https://blog.csdn.net/yourgrandfather_/article/details/135111459)
>    - [åŠ¨æ€è§„åˆ’â€”â€”01èƒŒåŒ…é—®é¢˜](https://blog.csdn.net/yourgrandfather_/article/details/135103012?spm=1001.2014.3001.5501)
>    - [åŠ¨æ€è§„åˆ’â€”â€”å¤šé‡èƒŒåŒ…é—®é¢˜](https://blog.csdn.net/yourgrandfather_/article/details/135125267)
>    - [åŠ¨æ€è§„åˆ’â€”â€”åˆ†ç»„èƒŒåŒ…é—®é¢˜](https://blog.csdn.net/yourgrandfather_/article/details/135134277)
>    - [åŠ¨æ€è§„åˆ’â€”â€”æœ€é•¿ä¸Šå‡å­åºåˆ—ï¼ˆLIS)](https://blog.csdn.net/yourgrandfather_/article/details/135150351)
>    - [äºŒå‰æ ‘çš„ä¸­åºéå†ï¼ˆä¸‰ç§æ–¹æ³•ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135167817)
>    - [æœ€é•¿å›æ–‡å­ä¸²](https://blog.csdn.net/yourgrandfather_/article/details/135183977)
>    - [æœ€çŸ­è·¯ç®—æ³•â€”â€”Dijkstraï¼ˆC++å®ç°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/134869064?spm=1001.2014.3001.5501)
>    - [æœ€çŸ­è·¯ç®—æ³•â€”â€”â€”Bellman_Fordç®—æ³•ï¼ˆC++å®ç°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/134935786?spm=1001.2014.3001.5501)
>    - [æœ€çŸ­è·¯ç®—æ³•â€”â€”â€”SPFAç®—æ³•ï¼ˆC++å®ç°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135004393?spm=1001.2014.3001.5501)
>    - [æœ€å°ç”Ÿæˆæ ‘ç®—æ³•â€”â€”â€”primç®—æ³•ï¼ˆC++å®ç°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135026901?spm=1001.2014.3001.5501)
>    - [æœ€å°ç”Ÿæˆæ ‘ç®—æ³•â€”â€”â€”Kruskalç®—æ³•ï¼ˆC++å®ç°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135039904?spm=1001.2014.3001.5501)
>    - [æŸ“è‰²æ³•åˆ¤æ–­äºŒåˆ†å›¾ï¼ˆC++å®ç°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135094296?spm=1001.2014.3001.5501)
> 2. **Linuxéƒ¨åˆ†ï¼ˆè¿˜åœ¨æ›´æ–°ä¸­ï¼‰ï¼š**
>    - [Linuxå­¦ä¹ ä¹‹åˆè¯†Linux](https://blog.csdn.net/yourgrandfather_/article/details/134953315?spm=1001.2014.3001.5501)
>    - [Linuxå­¦ä¹ ä¹‹å‘½ä»¤è¡ŒåŸºç¡€æ“ä½œ](https://blog.csdn.net/yourgrandfather_/article/details/134956923?spm=1001.2014.3001.5501)
>    - [Linuxå­¦ä¹ ä¹‹åŸºç¡€å‘½ä»¤ï¼ˆé€‚åˆå°ç™½ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135189166)
>    - [Linuxå­¦ä¹ ä¹‹æƒé™ç®¡ç†å’Œç”¨æˆ·ç®¡ç†](https://blog.csdn.net/yourgrandfather_/article/details/135222868)
>    - [Linuxå­¦ä¹ ä¹‹åˆ¶ä½œé™æ€åº“å’ŒåŠ¨æ€åº“](https://blog.csdn.net/yourgrandfather_/article/details/135275850)
>    - [Linuxå­¦ä¹ ä¹‹makefile](https://blog.csdn.net/yourgrandfather_/article/details/135288190)
>    - [Linuxå­¦ä¹ ä¹‹ç³»ç»Ÿç¼–ç¨‹1ï¼ˆå…³äºè¯»å†™ç³»ç»Ÿå‡½æ•°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135324720)
>    - [Linuxå­¦ä¹ ä¹‹ç³»ç»Ÿç¼–ç¨‹2ï¼ˆå…³äºè¿›ç¨‹åŠå…¶ç›¸å…³çš„å‡½æ•°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135338115)
>    - [Linuxå­¦ä¹ ä¹‹ç³»ç»Ÿç¼–ç¨‹3ï¼ˆè¿›ç¨‹åŠwaitå‡½æ•°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135354402)
>    - [Linuxå­¦ä¹ ä¹‹ç³»ç»Ÿç¼–ç¨‹4(è¿›ç¨‹é—´é€šä¿¡ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135383973)
>    - [Linuxå­¦ä¹ ä¹‹ç³»ç»Ÿç¼–ç¨‹5(ä¿¡å·ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135408188)

## âœ¨ğŸ‰æ€»ç»“

â€œç§ä¸€é¢—æ ‘æœ€å¥½çš„æ˜¯åå¹´å‰,å…¶æ¬¡å°±æ˜¯ç°åœ¨â€
æ‰€ä»¥,
â€œè®©æˆ‘ä»¬ä¸€èµ·åŠªåŠ›å§,å»å¥”èµ´æ›´é«˜æ›´è¿œçš„å±±æµ·â€
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/direct/7bb6bf71a1814bd88fb9615df5cc258d.png#pic_center =400x250)
å¦‚æœæœ‰é”™è¯¯âŒ,æ¬¢è¿æŒ‡æ­£å“ŸğŸ˜‹

ğŸ‰å¦‚æœè§‰å¾—æ”¶è·æ»¡æ»¡,å¯ä»¥åŠ¨åŠ¨å°æ‰‹,ç‚¹ç‚¹èµğŸ‘,æ”¯æŒä¸€ä¸‹å“ŸğŸ‰
