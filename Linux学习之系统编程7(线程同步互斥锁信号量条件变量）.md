> ### å†™åœ¨å‰é¢ï¼š
> 
> æˆ‘çš„Linuxçš„å­¦ä¹ ä¹‹è·¯éå¸¸åå·ã€‚ç¬¬ä¸€æ¬¡å­¦ä¹ Linuxæ˜¯åœ¨å¤§ä¸€ä¸‹çš„å¼€å­¦æ²¡å¤šä¹…ï¼Œç»“æœå› ä¸ºä¸ä¼šå®‰è£…VMwareå°±æ— ç–¾è€Œç»ˆäº†ï¼Œå¯ä»¥è¯´æ˜¯æ²¡å¼€å§‹å°±å¤±è´¥äº†ã€‚ç¬¬äºŒæ¬¡å­¦ä¹ Linuxæ˜¯åœ¨å¤§ä¸€ä¸‹å¿«æ”¾æš‘å‡ï¼ˆé‚£ä¸ªæ—¶å€™åˆšåˆšè¿‡å®Œè€ƒè¯•å‘¨ï¼‰ï¼Œæˆ‘æ²¡ä»€ä¹ˆäº‹åšå°±åˆé‡æ‹¾Linuxï¼Œä¸æœè¾“çš„æˆ‘é€‰æ‹©å†æˆ˜Linuxï¼Œè¿™ä¸€æ¬¡å­¦ä¹ è¿˜ç®—é¡ºåˆ©ï¼Œè™½ç„¶ä¸­é—´æœ‰äº›å°æ’æ›²ä½†æ˜¯ä¸å½±å“æ•´ä½“å­¦ä¹ è¿›åº¦ï¼Œ æˆ‘çœ‹ç€Bç«™ä¸Šçš„è§†é¢‘ä¸€ç‚¹ç‚¹å­¦ä¹ Linuxï¼ŒåŸºæœ¬ä¸ŠæŠŠLinuxçš„åŸºç¡€æŒ‡ä»¤å­¦å®Œäº†ã€‚å­¦å®Œä¹‹åæˆ‘åˆé‡åˆ°é—®é¢˜äº†ï¼Œè§†é¢‘åŸºæœ¬ä¸Šåˆ°è¿™å°±ç»“æŸäº†ï¼Œè€Œæˆ‘å´ä¸çŸ¥é“ä¸‹ä¸€æ­¥è¯¥å­¦ä»€ä¹ˆï¼Œäºæ˜¯å°±æ²¡æ€ä¹ˆç¢°Linuxï¼Œç»“æœæ²¡è¿‡å¤šé•¿æ—¶é—´æˆ‘å°±æŠŠå­¦çš„LinuxæŒ‡ä»¤å¿˜çš„ä¸€å¹²äºŒå‡€ã€‚ç°åœ¨æ˜¯æˆ‘ç¬¬ä¸‰æ¬¡å­¦ä¹ Linuxï¼Œæˆ‘å†³å®šé‡æ–°å¼€å§‹å­¦Linuxï¼ŒåŒæ—¶ä¸ºäº†è®©è‡ªå·±å­¦ä¹ çš„æ•ˆæœæ›´å¥½ï¼Œæˆ‘é€‰æ‹©ä»¥å†™blogçš„å½¢å¼é€¼è¿«è‡ªå·±æ¯å¤©æŠŠå­¦ä¹ åˆ°çš„LinuxçŸ¥è¯†æ•´ç†ä¸‹æ¥ã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘å†™è¿™ä¸ªç³»åˆ—blogçš„åŸå› ã€‚

---

## çº¿ç¨‹åŒæ­¥

### æ¦‚å¿µï¼š

ååŒæ­¥è°ƒï¼Œå¯¹å…¬å…±åŒºæ•°æ®æŒ‰åºè®¿é—®ï¼Œé˜²æ­¢æ•°æ®æ··ä¹±ï¼Œäº§ç”Ÿä¸æ—¶é—´æœ‰å…³çš„é”™è¯¯ã€‚

### æ•°æ®æ··ä¹±çš„åŸå› ï¼š

- èµ„æºå…±äº«ï¼ˆç‹¬äº«èµ„æºåˆ™ä¸ä¼šï¼‰
- è°ƒåº¦éšæœºï¼ˆæ„å‘³ç€æ•°æ®è®¿é—®ä¼šå‡ºç°ç«äº‰ï¼‰
- çº¿ç¨‹é—´ç¼ºä¹å¿…è¦åŒæ­¥æœºåˆ¶

### è§£å†³æ–¹æ³•

ä½¿ç”¨é”ã€‚å»ºè®®é”ï¼å¯¹å…¬å…±æ•°æ®è¿›è¡Œä¿æŠ¤ã€‚æ‰€æœ‰çº¿ç¨‹åº”è¯¥åœ¨è®¿é—®å…¬å…±æ•°æ®å‰å…ˆæ‹¿é”åœ¨è®¿é—®ï¼Œä½†é”æœ¬èº«ä¸å…·å¤‡å¼ºåˆ¶æ€§ã€‚

> è¿™æ®µè¯å¯èƒ½æœ‰ç‚¹ç»•ï¼Œæˆ‘åœ¨è¿™é‡Œç¨å¾®è§£é‡Šä¸€ä¸‹ã€‚æ­£ç¡®ä½¿ç”¨é”å¯ä»¥ä¿è¯**çº¿ç¨‹åŒæ­¥**ï¼Œä½†ä½ ä¹Ÿå¯ä»¥**ä¸ä½¿ç”¨é”ç›´æ¥å»è®¿é—®å…¬å…±æ•°æ®**ï¼Œä¹Ÿå¯ä»¥è®¿é—®åˆ°ï¼Œä½†è¿™æ ·å°±ä¸èƒ½ä¿è¯çº¿ç¨‹åŒæ­¥ï¼Œå°±æ˜¯è¯´**ç¨‹åºæœ¬èº«å¹¶ä¸èƒ½å¼ºåˆ¶ä½ ä½¿ç”¨é”ã€‚**

### æ•°æ®æ··ä¹±çš„æ¼”ç¤º

æºä»£ç ï¼š

```c
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<unistd.h>
#include<pthread.h>

pthread_mutex_t mutex;

void sys_err(char* str,int errno)
{
    fprintf(stderr,"%s:%s",str,strerror(errno));
    exit(-1);
}

void* fun(void* arg)
{
    while(1)
    {
        printf("hellow ");
        sleep(rand()%3);
        printf("world\n");
        sleep(rand()%3);
    }
    return NULL;
}


int main()
{
    pthread_t tid;
    srand(time(NULL));
    int res=pthread_mutex_init(&mutex,NULL);
    if(res!=0)
        sys_err("init error",res);
    res=pthread_create(&tid,NULL,fun,NULL);
    if(res!=0)
        sys_err("pthread create error",res);
    while(1)
    {
        printf("HELLOW ");
        sleep(rand()%3);
        printf("WORLD\n");
        sleep(rand()%3);
    }
    return 0;
}
```

æ•ˆæœï¼š
![1](https://img-blog.csdnimg.cn/direct/ca563c86c8e446319cb798d1c6efe441.png#pic_center)

> æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„æœ¬æ„æ˜¯è®©å¤§å†™çš„â€œHELLOW WORLDâ€å’Œå°å†™çš„â€œhellow worldâ€åœ¨ä¸€è¡Œè¾“å‡ºï¼Œè¿™é‡Œçš„å…¬å…±èµ„æºæ˜¯å±å¹•`STDOUT_FILENO`ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬è®©æ¯ä¸€ä¸ªçº¿ç¨‹æ‰“å°å®Œä¸Šä¸€å¥è¯å°±ç¡ä¸€ä¸‹ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´çº¿ç¨‹æ··ä¹±ã€‚

## å€ŸåŠ©äº’æ–¥é”å®ç°çº¿ç¨‹åŒæ­¥

### ç›¸å…³å‡½æ•°çš„ä»‹ç»

- `pthread_mutex_t mutex`è¿™ä¸ªä¸æ˜¯å‡½æ•°ï¼Œæ˜¯ä¸€ä¸ªç±»å‹ã€‚æ˜¯åé¢å‡½æ•°éƒ½ä¼šç”¨åˆ°çš„å‚æ•°ã€‚
- `int pthread_mutex_init(pthread_mutex_t* restrict mutex,const pthread_mutexattr_t* restrict attr);`åˆ›å»º
- `int pthread_mutex_destory(pthread_mutex* mutex);`é”€æ¯
- `int pthread_mutex_lock(pthread_mutex_t *mutex);`ä¸Šé”
- `int pthread_mutex_trylock(pthread_mutex_t *mutex);`å°è¯•ä¸Šé”
- `int pthread_mutex_unlock(pthread_mutex_t *mutex);`è§£é”

> **restrictï¼ˆå…³é”®å­—ï¼‰**: ç”¨æ¥é™å®šæŒ‡é’ˆå˜é‡ã€‚è¢«è¯¥å…³é”®å­—é™å®šçš„æŒ‡é’ˆå˜é‡æ‰€æŒ‡å‘çš„å†…å­˜æ“ä½œï¼Œå¿…é¡»ç”±æœ¬æŒ‡é’ˆå®Œæˆã€‚

> `pthread_mutex_t `ç±»å‹ï¼Œå…¶**æœ¬è´¨æ˜¯ä¸€ä¸ªç»“æ„ä½“**ã€‚ä¸ºç®€åŒ–ç†è§£ï¼Œåº”ç”¨æ—¶å¯å¿½ç•¥å…¶å®ç°ç»†èŠ‚ï¼Œ**ç®€å•å½“æˆæ•´æ•°çœ‹å¾…**`pthread_mutex_t mutex`ï¼›å˜é‡`mutex`åªæœ‰ä¸¤ç§å–å€¼ï¼š0,1

### ä½¿ç”¨é”ï¼ˆäº’æ–¥é‡ï¼Œäº’æ–¥é”ï¼‰çš„ä¸€èˆ¬æ­¥éª¤

1. `pthread_mutex_t lock;`  åˆ›å»ºé”
2. `pthread_mutex_init;` åˆå§‹åŒ–
3. `pthread_mutex_lock;`åŠ é”    
4. è®¿é—®å…±äº«æ•°æ®
5. `pthrad_mutext_unlock();`è§£é”
6. `pthead_mutex_destroyï¼›`é”€æ¯é”

### åˆå§‹åŒ–äº’æ–¥é‡

1. åŠ¨æ€åˆå§‹åŒ–ï¼š`pthread_mutex_init(&mutex,NULL);`
2. é™æ€åˆå§‹åŒ–ï¼š`pthread_mutex_t mutex=PTHREAD_MUTEX_INITIALIZER`    

### ä¸¾ä¸ªæ —å­

æˆ‘ä»¬è¿˜æ˜¯å®ç°ä¸Šé¢çš„åŠŸèƒ½ï¼Œåªä¸è¿‡è¿™æ¬¡æˆ‘ä»¬åŠ é”ï¼Œå®ç°å¤§å†™çš„åœ¨ä¸€è¡Œï¼Œå°å†™çš„åœ¨ä¸€è¡Œã€‚
æºä»£ç ï¼š

```c
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<unistd.h>
#include<pthread.h>

pthread_mutex_t mutex;

void sys_err(char* str,int errno)
{
    fprintf(stderr,"%s:%s\n",str,strerror(errno));
    exit(-1);
}

void* fun(void* arg)
{
    while(1)
    {
        pthread_mutex_lock(&mutex);
        printf("hellow ");
        sleep(rand()%3);
        printf("world\n");
        pthread_mutex_unlock(&mutex);
        sleep(rand()%3);
    }
    return NULL;
}


int main()
{
    pthread_t tid;
    srand(time(NULL));
    int res=pthread_mutex_init(&mutex,NULL);
    if(res!=0)
        sys_err("mutex init",res);
    res=pthread_mutex_init(&mutex,NULL);
    if(res!=0)
        sys_err("init error",res);
    res=pthread_create(&tid,NULL,fun,NULL);
    if(res!=0)
        sys_err("pthread create error",res);
    while(1)
    {
        pthread_mutex_lock(&mutex);
        printf("HELLOW ");
        sleep(rand()%3);
        printf("WORLD\n");
        pthread_mutex_unlock(&mutex);
        sleep(rand()%3);
    }
    return 0;
}
```

æ•ˆæœï¼š
![2](https://img-blog.csdnimg.cn/direct/0847bd8034704dbaa6ec1be39964b53a.png#pic_center)

### ä½¿ç”¨æŠ€å·§

æ³¨æ„äº‹é¡¹

- å°½é‡ä¿è¯é”çš„ç²’åº¦ï¼Œ è¶Šå°è¶Šå¥½ã€‚ï¼ˆè®¿é—®å…±äº«æ•°æ®å‰ï¼ŒåŠ é”ã€‚è®¿é—®ç»“æŸ**ç«‹å³è§£é”**ã€‚ï¼‰
- äº’æ–¥é”ï¼Œæœ¬è´¨æ˜¯ç»“æ„ä½“ã€‚ æˆ‘ä»¬å¯ä»¥çœ‹æˆæ•´æ•°ã€‚ åˆå€¼ä¸º 1ã€‚ï¼ˆ`pthread_mutex_init() `å‡½æ•°è°ƒç”¨æˆåŠŸï¼‰

æŠ€å·§

- åŠ é”ï¼š --æ“ä½œï¼Œ é˜»å¡çº¿ç¨‹ã€‚
- è§£é”ï¼š ++æ“ä½œï¼Œ å”¤é†’é˜»å¡åœ¨é”ä¸Šçš„çº¿ç¨‹ã€‚
- tryé”ï¼šå°è¯•åŠ é”ï¼ŒæˆåŠŸ--ã€‚å¤±è´¥ï¼Œè¿”å›ã€‚åŒæ—¶è®¾ç½®é”™è¯¯å· `EBUSY`

### ä¸¤ç§æ­»é”

1. å¯¹ä¸€ä¸ªé”åå¤åŠ é”
   æºä»£ç ï¼š

```c
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<unistd.h>
#include<pthread.h>

pthread_mutex_t mutex;

int main()
{
    pthread_t tid;
    pthread_mutex_init(&mutex,NULL);
    pthread_mutex_lock(&mutex);
    pthread_mutex_lock(&mutex);
    printf("hello linux\n");
    return 0;
}
```

æ•ˆæœå°±æ˜¯å…‰æ ‡ä¸€ç›´åœ¨é—ªï¼Œç¨‹åºä¸€ç›´é˜»å¡åœ¨é‚£é‡Œã€‚

2. ä¸¤ä¸ªçº¿ç¨‹ï¼Œå„è‡ªæŒæœ‰ä¸€æŠŠé”ï¼Œè¯·æ±‚å¦ä¸€æŠŠé”
   æºä»£ç ï¼š

```c
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<unistd.h>
#include<pthread.h>

pthread_mutex_t mutex1;
pthread_mutex_t mutex2;

void* fun(void* arg)
{
    pthread_mutex_lock(&mutex2);
    sleep(1);
    printf("hello linux\n");
    pthread_mutex_lock(&mutex1);
    return NULL;
}

int main()
{
    pthread_t tid;
    pthread_mutex_init(&mutex1,NULL);
    pthread_mutex_init(&mutex2,NULL);
    pthread_create(&tid,NULL,fun,NULL);
    pthread_mutex_lock(&mutex1);
    sleep(1);
    printf("HELLO LINUX\n");
    pthread_mutex_lock(&mutex2);    
    printf("hello linux\n");
    return 0;
}
```

æ•ˆæœå’Œä¸Šé¢ä¸€ç§æ­»é”ä¸€æ ·ï¼Œå…‰æ ‡ä¸€ç›´åœ¨é‚£é—ªã€‚

---

## è¯»å†™é”

### åŸç†

- é”åªæœ‰ä¸€æŠŠã€‚ä»¥è¯»æ–¹å¼ç»™æ•°æ®åŠ é”â€”â€”è¯»é”ã€‚ä»¥å†™æ–¹å¼ç»™æ•°æ®åŠ é”â€”â€”å†™é”ã€‚
- **è¯»å…±äº«ï¼Œå†™ç‹¬å ã€‚**
- **å†™é”ä¼˜å…ˆçº§é«˜ã€‚**
- ç›¸è¾ƒäºäº’æ–¥é‡è€Œè¨€ï¼Œå½“è¯»çº¿ç¨‹å¤šçš„æ—¶å€™ï¼Œæé«˜è®¿é—®æ•ˆç‡ã€‚

### ç›¸å…³å‡½æ•°

- `pthread_rwlock_t rwlock;`è¿™ä¸æ˜¯å‡½æ•°ï¼Œæ˜¯ä¸ªç±»å‹ã€‚
- `pthread_rwlock_init(&rwlock, NULL);`:åˆ›å»º
- `pthread_rwlock_rdlock(&rwlock);`ï¼šåŠ è¯»é”
- `pthread_rwlock_wrlock(&rwlock);`ï¼šåŠ å†™é”
- `pthread_rwlock_unlock(&rwlock);`ï¼šè§£é”
- `pthread_rwlock_destroy(&rwlock);`é”€æ¯é”

### ä¸¾ä¸ªæ —å­

ç”±äºè¿™ä¸ªè¯»å†™ä¸æ˜¯é‡ç‚¹ï¼Œæˆ‘å°±ä¸äº²è‡ªå†™äº†ã€‚
æºä»£ç ï¼š
![1](https://img-blog.csdnimg.cn/img_convert/e5bb3b04533ca5bb3bd048cccc7b838f.png#pic_center)
æ•ˆæœï¼š
![2](https://img-blog.csdnimg.cn/img_convert/85781c5e56ebbe11999a53a88e457894.png#pic_center)

---

## æ¡ä»¶å˜é‡

æ¡ä»¶å˜é‡ä¸æ˜¯é”ï¼Œä½†æ˜¯é€šå¸¸ç»“åˆé”æ¥ä½¿ç”¨ã€‚

### ç›¸å…³å‡½æ•°

- `pthread_cond_t cond;`è¿™ä¸æ˜¯å‡½æ•°ï¼Œæ˜¯ä¸€ä¸ªç±»å‹
- `pthread_cond_init();`ï¼šåˆ›å»ºæ¡ä»¶å˜é‡
- `pthread_cond_destroy();`ï¼šé”€æ¯æ¡ä»¶å˜é‡
- `pthread_cond_wait();`ï¼šé˜»å¡ç­‰å¾…æ¡ä»¶
- `pthread_cond_timewait();`ï¼šæœ‰æ—¶é™çš„é˜»å¡ç­‰å¾…æ¡ä»¶
- `pthread-cond_signal();`ï¼šè‡³å°‘é€šçŸ¥ä¸€ä¸ªé˜»å¡ç­‰å¾…çš„æ¡ä»¶å˜é‡
- `pthread-cond_broadcast();`é€šçŸ¥æ‰€æœ‰é˜»å¡ç­‰å¾…çš„æ¡ä»¶å˜é‡

### åˆå§‹åŒ–æ¡ä»¶å˜é‡

1. åŠ¨æ€åˆå§‹åŒ–ï¼š`pthread_cond_init(&cond,NULL);`
2. é™æ€åˆå§‹åŒ–ï¼š`pthread_cond_t cond=PTHREAD_COND_INITIALIZER;`
   
   ### é‡ç‚¹å‡½æ•°è®²è§£
   
   `pthread_cond_wait(&cond,&mutex)`
   ä½œç”¨
3. é˜»å¡ç­‰å¾…æ¡ä»¶å˜é‡æ»¡è¶³
4. è§£é”å·²ç»åŠ é”æˆåŠŸçš„ä¿¡å·é‡ ï¼ˆç›¸å½“äº` pthread_mutex_unlock(&mutex)`ï¼‰ï¼Œ1,2ä¸¤æ­¥ä¸ºä¸€ä¸ªåŸå­æ“ä½œ.
5. å½“æ¡ä»¶æ»¡è¶³ï¼Œå‡½æ•°è¿”å›æ—¶ï¼Œè§£é™¤é˜»å¡å¹¶é‡æ–°ç”³è¯·è·å–äº’æ–¥é”ã€‚é‡æ–°åŠ é”ä¿¡å·é‡ ï¼ˆç›¸å½“äº`pthread_mutex_lock(&mutex);`ï¼‰

---

## æ¡ä»¶å˜é‡çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å‹

### æ€è·¯ï¼š

![1](https://img-blog.csdnimg.cn/direct/5092f4437b144fd5b3697f7355f28aa8.png#pic_center)

### å•ä¸ªæ¶ˆè´¹è€…æ¨¡å‹

æºä»£ç ï¼š

```c
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<unistd.h>
#include<pthread.h>

struct mesg
{
    int num;
    struct mesg* next;
};

struct mesg* head;

pthread_mutex_t mutex=PTHREAD_MUTEX_INITIALIZER;
pthread_cond_t cond=PTHREAD_COND_INITIALIZER;

void sys_err(char* str,int errno)
{
    fprintf(stderr,"%s:%s\n",str,strerror(errno));
    exit(-1);
}

void* produser(void* arg)
{
    while(1)
    {
        struct mesg* m=malloc(sizeof (struct mesg));
        m->num=rand()%1000+1;
        printf("---produce:%d\n",m->num);
        pthread_mutex_lock(&mutex);
        m->next=head;
        head=m;
        pthread_mutex_unlock(&mutex);
        pthread_cond_signal(&cond);
        sleep(rand()%3);
    }
    return NULL;
}

void* consumer(void* arg)
{
    while(1)
    {
        struct mesg* m;
        pthread_mutex_lock(&mutex);
        if(head==NULL)
            pthread_cond_wait(&cond,&mutex);
        m=head;
        head=m->next;
        pthread_mutex_unlock(&mutex);
        printf("----------consume:%d\n",m->num);
        free(m);
        sleep(rand()%3);
    }
    return NULL;
}



int main()
{
    pthread_t tid_pro,tid_con;
    srand(time(NULL));
    int res=pthread_create(&tid_pro,NULL,produser,NULL);
    if(res!=0)
        sys_err("pthread create error",res);
    res=pthread_create(&tid_con,NULL,consumer,NULL);
    if(res!=0)
        sys_err("pthread create error",res);
    pthread_detach(tid_pro);    //if use this way,must use pthread_exit to exit main pthread.
    pthread_detach(tid_con);
//    pthread_join(tid_pro,NULL);
//    pthread_join(tid_con,NULL);
//    return 0;
    pthread_exit(0);
}
```

æ•ˆæœï¼š
![2](https://img-blog.csdnimg.cn/direct/a02ff5edaac64254be027fab6db26f45.png#pic_center)

### å¤šä¸ªæ¶ˆè´¹è€…æ¨¡å‹

æºä»£ç ï¼š

```c
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<unistd.h>
#include<pthread.h>

struct mesg
{
    int num;
    struct mesg* next;
};

struct mesg* head;

pthread_mutex_t mutex=PTHREAD_MUTEX_INITIALIZER;
pthread_cond_t cond=PTHREAD_COND_INITIALIZER;

void sys_err(char* str,int errno)
{
    fprintf(stderr,"%s:%s\n",str,strerror(errno));
    exit(-1);
}

void* produser(void* arg)
{
    while(1)
    {
        struct mesg* m=malloc(sizeof (struct mesg));
        m->num=rand()%1000+1;
        printf("---produce:%d\n",m->num);
        pthread_mutex_lock(&mutex);
        m->next=head;
        head=m;
        pthread_mutex_unlock(&mutex);
        pthread_cond_signal(&cond);
        sleep(rand()%3);
    }
    return NULL;
}

void* consumer(void* arg)
{
    int i=(int) arg;
    while(1)
    {
        struct mesg* m;
        pthread_mutex_lock(&mutex);
        while(head==NULL)
            pthread_cond_wait(&cond,&mutex);
        m=head;
        head=m->next;
        pthread_mutex_unlock(&mutex);
        printf("%dth consumer----------consume:%d\n",i,m->num);
        free(m);
        sleep(rand()%3);
    }
    return NULL;
}



int main()
{
    pthread_t tid_pro,tid_con1,tid_con2,tid_con3;
    srand(time(NULL));
    int res=pthread_create(&tid_pro,NULL,produser,NULL);
    if(res!=0)
        sys_err("pthread create error",res);
    res=pthread_create(&tid_con1,NULL,consumer,(void*)1);
    if(res!=0)
        sys_err("pthread create error",res);
    res=pthread_create(&tid_con2,NULL,consumer,(void*)2);
    if(res!=0)
        sys_err("pthread create error",res);
    res=pthread_create(&tid_con3,NULL,consumer,(void*)3);
    if(res!=0)
        sys_err("pthread create error",res);
//    pthread_detach(tid_pro);    
//    pthread_detach(tid_con);
    pthread_join(tid_pro,NULL);
    pthread_join(tid_con1,NULL);
    pthread_join(tid_con2,NULL);
    pthread_join(tid_con3,NULL);
    return 0;
}
```

æ•ˆæœï¼š
![3](https://img-blog.csdnimg.cn/direct/288dc919c4464e179f900f729ca11b7f.png#pic_center)

> **æ³¨æ„äº‹é¡¹**
> æˆ‘ä»¬åœ¨å¤šä¸ªæ¶ˆè´¹è€…æ¨¡å‹ä¸€å®šåœ¨æ¶ˆè´¹è€…çº¿ç¨‹ä¸­æŠŠç­‰å¾…é˜»å¡çš„åˆ¤æ–­ä»`if`æ”¹æˆ`while`.
> 
> 1. ä¸¤ä¸ªæ¶ˆè´¹è€…éƒ½é˜»å¡åœ¨æ¡ä»¶å˜é‡ä¸Šï¼Œå°±æ˜¯è¯´æ²¡æœ‰æ•°æ®å¯ä»¥æ¶ˆè´¹ã€‚
> 2. å®Œäº‹å„¿éƒ½æŠŠé”è¿˜å›å»äº†ï¼Œç”Ÿäº§è€…æ­¤æ—¶ç”Ÿäº§äº†ä¸€ä¸ªæ•°æ®ï¼Œä¼šåŒæ—¶å”¤é†’ä¸¤ä¸ªå› æ¡ä»¶å˜é‡é˜»å¡çš„æ¶ˆè´¹è€…ï¼Œå®Œäº‹å„¿ä¸¤ä¸ªæ¶ˆè´¹è€…å»æŠ¢é”ã€‚
> 3. ç»“æœå°±æ˜¯Aæ¶ˆè´¹è€…æ‹¿åˆ°é”ï¼Œå¼€å§‹æ¶ˆè´¹æ•°æ®ï¼ŒBæ¶ˆè´¹è€…é˜»å¡åœ¨é”ä¸Šï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚
> 4. ä¹‹åAæ¶ˆè´¹å®Œæ•°æ®ï¼ŒæŠŠé”å½’è¿˜ï¼ŒBè¢«å”¤é†’ï¼Œç„¶è€Œæ­¤æ—¶å·²ç»æ²¡æœ‰æ•°æ®ä¾›Bæ¶ˆè´¹äº†ã€‚
> 5. æ‰€ä»¥è¿™é‡Œæœ‰ä¸ªé€»è¾‘é”™è¯¯ï¼Œæ¶ˆè´¹è€…é˜»å¡åœ¨æ¡ä»¶å˜é‡é‚£é‡Œåº”è¯¥ä½¿ç”¨whileå¾ªç¯ã€‚è¿™æ ·Aæ¶ˆè´¹å®Œæ•°æ®åï¼ŒBåšçš„ç¬¬ä¸€ä»¶äº‹ä¸æ˜¯å»æ‹¿é”ï¼Œè€Œæ˜¯åˆ¤å®šæ¡ä»¶å˜é‡ã€‚
>    ![4](https://img-blog.csdnimg.cn/img_convert/c4057760a3166dc1f6ab31011bc7a759.png#pic_center)
>    **å®æµ‹ï¼Œå¦‚æœä¸æ”¹çš„è¯å°±ä¼šå‘ç”Ÿæ®µé”™è¯¯ã€‚**

---

## ä¿¡å·é‡å®ç°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å‹

### ä¿¡å·é‡çš„ä½œç”¨

- åº”ç”¨äºçº¿ç¨‹ã€è¿›ç¨‹é—´åŒæ­¥ã€‚
- ç›¸å½“äº åˆå§‹åŒ–å€¼ä¸º N çš„äº’æ–¥é‡ã€‚  Nå€¼ï¼Œè¡¨ç¤ºå¯ä»¥åŒæ—¶è®¿é—®å…±äº«æ•°æ®åŒºçš„çº¿ç¨‹æ•°ã€‚

### ç›¸å…³çš„å‡½æ•°

- `sem_t sem`è¿™ä¸æ˜¯å‡½æ•°ï¼Œæ˜¯ç±»å‹ã€‚
- `int sem_init(sem_t *sem, int pshared, unsigned int value);`åˆ›å»ºä¿¡å·é‡
- `sem_destroy();`:é”€æ¯ä¿¡å·é‡
- `sem_wait();`:ä¸€æ¬¡è°ƒç”¨ï¼Œåšä¸€æ¬¡-- æ“ä½œï¼Œ å½“ä¿¡å·é‡çš„å€¼ä¸º 0 æ—¶ï¼Œå†æ¬¡ -- å°±ä¼šé˜»å¡ã€‚ ï¼ˆå¯¹æ¯” `pthread_mutex_lock`ï¼‰
- `sem_post();`:ä¸€æ¬¡è°ƒç”¨ï¼Œåšä¸€æ¬¡++ æ“ä½œ. å½“ä¿¡å·é‡çš„å€¼ä¸º N æ—¶, å†æ¬¡ ++ å°±ä¼šé˜»å¡ã€‚ï¼ˆå¯¹æ¯” `pthread_mutex_unlock`ï¼‰

### é‡è¦å‡½æ•°

`int sem_init(sem_t *sem, int pshared, unsigned int value);`
å‚æ•°ï¼š

- `sem`:ä¿¡å·é‡
- `pshared`:0è¡¨ç¤ºçº¿ç¨‹åŒæ­¥ï¼Œ1è¡¨ç¤ºè¿›ç¨‹åŒæ­¥
- `value`:Nå€¼ã€‚ï¼ˆæŒ‡å®šåŒæ—¶è®¿é—®çš„çº¿ç¨‹æ•°ï¼‰

### æ¨¡å‹

æºä»£ç ï¼š

```c
#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<unistd.h>
#include<pthread.h>
#include<semaphore.h>

#define MAX 5
sem_t blank,product;
int queue[MAX];

void* producer(void* arg)
{
    int i=0;
    while(1)
    {
        sem_wait(&blank);
        queue[i]=rand()%1000+1;
        sem_post(&product);
        printf("-------------producer:%d\n",queue[i]);
        i=(i+1)%MAX;
        sleep(rand()%2);
    }
    return NULL;
}

void* consumer(void* arg)
{
    int i=0;
    while(1)
    {
        sem_wait(&product);
        printf("---consumer:%d\n",queue[i]);
        sem_post(&blank);
        i=(i+1)%MAX;
        sleep(rand()%2);
    }
    return NULL;
}


int main()
{
    pthread_t ctid,ptid;

    srand(time(NULL));

    sem_init(&blank,0,MAX);
    sem_init(&product,0,0);        //why set 0?This is mean 0 pthread visit in the same time?

    pthread_create(&ctid,NULL,producer,NULL);
    pthread_create(&ptid,NULL,consumer,NULL);

    pthread_join(ctid,NULL);
    pthread_join(ptid,NULL);

    sem_destroy(&blank);
    sem_destroy(&product);

    return 0;
}
```

æ•ˆæœï¼š
![1](https://img-blog.csdnimg.cn/direct/ca536009bfa64647909fa14d1ec3a47c.png#pic_center)

---

## å†™åœ¨æœ€å

ä¸ªäººäº²èº«ç»éªŒï¼šæˆ‘ä»¬å­¦ä¹ çš„ä¸€ç³»åˆ—Linuxå‘½ä»¤ï¼Œä¸€å®šè¦è‡ªå·±**äº²æ‰‹å»æ•²**ã€‚ä¸è¦åªæ˜¯çœ‹åˆ«äººæ•²ä»£ç ï¼Œä¸è¦åªæ˜¯åœç•™åœ¨çœ¼ç›çœ‹ï¼Œè„‘è¢‹ä»¥ä¸ºè‡ªå·±æ‡‚äº†ï¼Œç­‰ä½ å®é™…ä¸Šæ‰‹å»æ•²ä¼šå‘ç°è®¸è®¸å¤šå¤šçš„è¿™æ ·é‚£æ ·çš„é—®é¢˜ã€‚æ¯•ç«Ÿâ€œ**å®è·µå‡ºçœŸçŸ¥**â€ã€‚

---

> å¦‚æœä½ è§‰å¾—æˆ‘å†™çš„é¢˜è§£è¿˜ä¸é”™çš„ï¼Œè¯·å„ä½**ç‹å­å…¬ä¸»**ç§»æ­¥åˆ°æˆ‘çš„å…¶ä»–é¢˜è§£çœ‹çœ‹
> 
> 1. **æ•°æ®ç»“æ„ä¸ç®—æ³•éƒ¨åˆ†ï¼ˆè¿˜åœ¨æ›´æ–°ä¸­ï¼‰ï¼š**
>    - [***C++ STLæ€»ç»“ - åŸºäºç®—æ³•ç«èµ›ï¼ˆå¼ºåŠ›æ¨è***ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135051716?spm=1001.2014.3001.5501)
>    - [åŠ¨æ€è§„åˆ’â€”â€”01èƒŒåŒ…é—®é¢˜](https://blog.csdn.net/yourgrandfather_/article/details/135103012?spm=1001.2014.3001.5501)
>    - [åŠ¨æ€è§„åˆ’â€”â€”å®Œå…¨èƒŒåŒ…é—®é¢˜](https://blog.csdn.net/yourgrandfather_/article/details/135111459)
>    - [åŠ¨æ€è§„åˆ’â€”â€”å¤šé‡èƒŒåŒ…é—®é¢˜](https://blog.csdn.net/yourgrandfather_/article/details/135125267)
>    - [åŠ¨æ€è§„åˆ’â€”â€”åˆ†ç»„èƒŒåŒ…é—®é¢˜](https://blog.csdn.net/yourgrandfather_/article/details/135134277)
>    - [åŠ¨æ€è§„åˆ’â€”â€”æœ€é•¿ä¸Šå‡å­åºåˆ—ï¼ˆLIS)](https://blog.csdn.net/yourgrandfather_/article/details/135150351)
>    - [äºŒå‰æ ‘çš„ä¸­åºéå†ï¼ˆä¸‰ç§æ–¹æ³•ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135167817)
>    - [æœ€é•¿å›æ–‡å­ä¸²](https://blog.csdn.net/yourgrandfather_/article/details/135183977)
>    - [æœ€çŸ­è·¯ç®—æ³•â€”â€”Dijkstraï¼ˆC++å®ç°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/134869064?spm=1001.2014.3001.5501)
>    - [æœ€çŸ­è·¯ç®—æ³•â€”â€”â€”Bellman_Fordç®—æ³•ï¼ˆC++å®ç°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/134935786?spm=1001.2014.3001.5501)
>    - [æœ€çŸ­è·¯ç®—æ³•â€”â€”â€”SPFAç®—æ³•ï¼ˆC++å®ç°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135004393?spm=1001.2014.3001.5501)
>    - [æœ€å°ç”Ÿæˆæ ‘ç®—æ³•â€”â€”â€”primç®—æ³•ï¼ˆC++å®ç°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135026901?spm=1001.2014.3001.5501)
>    - [æœ€å°ç”Ÿæˆæ ‘ç®—æ³•â€”â€”â€”Kruskalç®—æ³•ï¼ˆC++å®ç°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135039904?spm=1001.2014.3001.5501)
> 2. **Linuxéƒ¨åˆ†ï¼ˆè¿˜åœ¨æ›´æ–°ä¸­ï¼‰ï¼š**
>    - [Linuxå­¦ä¹ ä¹‹åˆè¯†Linux](https://blog.csdn.net/yourgrandfather_/article/details/134953315?spm=1001.2014.3001.5501)
>    - [Linuxå­¦ä¹ ä¹‹å‘½ä»¤è¡ŒåŸºç¡€æ“ä½œ](https://blog.csdn.net/yourgrandfather_/article/details/134956923?spm=1001.2014.3001.5501)
>    - [Linuxå­¦ä¹ ä¹‹åŸºç¡€å‘½ä»¤ï¼ˆé€‚åˆå°ç™½ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135189166)
>    - [Linuxå­¦ä¹ ä¹‹æƒé™ç®¡ç†å’Œç”¨æˆ·ç®¡ç†](https://blog.csdn.net/yourgrandfather_/article/details/135222868)
>    - [Linuxå­¦ä¹ ä¹‹åˆ¶ä½œé™æ€åº“å’ŒåŠ¨æ€åº“](https://blog.csdn.net/yourgrandfather_/article/details/135275850)
>    - [Linuxå­¦ä¹ ä¹‹makefile](https://blog.csdn.net/yourgrandfather_/article/details/135288190)
>    - [Linuxå­¦ä¹ ä¹‹ç³»ç»Ÿç¼–ç¨‹1ï¼ˆå…³äºè¯»å†™ç³»ç»Ÿå‡½æ•°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135324720)
>    - [Linuxå­¦ä¹ ä¹‹ç³»ç»Ÿç¼–ç¨‹2ï¼ˆå…³äºè¿›ç¨‹åŠå…¶ç›¸å…³çš„å‡½æ•°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135338115)
>    - [Linuxå­¦ä¹ ä¹‹ç³»ç»Ÿç¼–ç¨‹3ï¼ˆè¿›ç¨‹åŠwaitå‡½æ•°ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135354402)
>    - [Linuxå­¦ä¹ ä¹‹ç³»ç»Ÿç¼–ç¨‹4(è¿›ç¨‹é—´é€šä¿¡ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135383973)
>    - [Linuxå­¦ä¹ ä¹‹ç³»ç»Ÿç¼–ç¨‹5(ä¿¡å·ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135408188)
>    - [Linuxå­¦ä¹ ä¹‹ç³»ç»Ÿç¼–ç¨‹6(çº¿ç¨‹ï¼‰](https://blog.csdn.net/yourgrandfather_/article/details/135438595)

## âœ¨ğŸ‰æ€»ç»“

â€œç§ä¸€é¢—æ ‘æœ€å¥½çš„æ˜¯åå¹´å‰,å…¶æ¬¡å°±æ˜¯ç°åœ¨â€
æ‰€ä»¥,
â€œè®©æˆ‘ä»¬ä¸€èµ·åŠªåŠ›å§,å»å¥”èµ´æ›´é«˜æ›´è¿œçš„å±±æµ·â€
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/direct/7bb6bf71a1814bd88fb9615df5cc258d.png#pic_center =400x250)
å¦‚æœæœ‰é”™è¯¯âŒ,æ¬¢è¿æŒ‡æ­£å“ŸğŸ˜‹

ğŸ‰å¦‚æœè§‰å¾—æ”¶è·æ»¡æ»¡,å¯ä»¥åŠ¨åŠ¨å°æ‰‹,ç‚¹ç‚¹èµğŸ‘,æ”¯æŒä¸€ä¸‹å“ŸğŸ‰
